# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-maven

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
name: Java Jar To Zip Publish
run-name: "[${{ (github.event.inputs.push_to_registry == 'true' && github.event.inputs.push_to_github_release == 'true') && '正式版' || '测试版' }}] Jar ${{ github.event.inputs.tag_name || github.ref_name || 'v-manual' }}  version"

on:
  push:
    branches:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: '输入 Release 标签 (eg: v0.35.1, v0.36.5-alpha.1)'
        required: false
        type: string
        default: 'v-manual'
      skip_tests:
        description: '是否跳过测试 (true/false)'
        required: true
        type: boolean
        default: false
      java_version:
        description: '输入 Java 版本 (如 8, 11, 17)'
        required: true
        default: '8'
      jar_dir_prefix:
        description: 'JAR 文件前缀 (如 ws-service 或留空)'
        default: ''
      draft:
        description: '是否为草稿 Release (true/false)'
        type: boolean
        default: false
      prerelease:
        description: '是否为预发布 Release (true/false)'
        type: boolean
        default: false
      push_to_registry:
        description: '是否推送到镜像仓库'
        required: true
        type: boolean
        default: true
      push_to_github_release:
        description: '是否推送到Github Release'
        required: true
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      #releases: write
      actions: read
    steps:
      - name: 1.调试触发信息
        run: |
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Tag Name: ${{ github.event.inputs.tag_name || github.ref_name }}"
          echo "Skip Tests: ${{ github.event.inputs.skip_tests || true }}"
          echo "Java Version: ${{ github.event.inputs.java_version ||secrets.JAVA_VERSION|| '8' }}"
          echo "Jar Dir Prefix: ${{ github.event.inputs.jar_dir_prefix || 'ws-service' }}"
          echo "Draft: ${{ github.event.inputs.draft || false }}"
          echo "Prerelease: ${{ github.event.inputs.prerelease || false }}"
          echo "Repository: ${{ github.repository }}"
          echo "SHA: ${{ github.sha }}"

      - name: 2.检出代码
        uses: actions/checkout@v4

      - name: 3.设置输入值
        run: |
          
          AUTO=false
          
          TAG_NAME="${{ github.event.inputs.tag_name || github.ref_name }}"
          # 判断是否为自动触发（TAG_NAME以'v'开头）
          if [[ "$TAG_NAME" == v* ]]; then
              AUTO=true
          fi
          echo "AUTO=$AUTO" >> $GITHUB_ENV
          SKIP_TESTS="${{ github.event.inputs.skip_tests || true }}"
          JAVA_VERSION="${{ github.event.inputs.java_version ||secrets.JAVA_VERSION|| '8' }}"
          JAR_DIR_PREFIX="${{ github.event.inputs.jar_dir_prefix || 'ws-service' }}"
          DRAFT="${{ github.event.inputs.draft || false }}"
          PRERELEASE="${{ github.event.inputs.prerelease || false }}" 
          PUSH_TO_REGISTRY="${{ github.event.inputs.push_to_registry  || env.AUTO }}"
          PUSH_TO_GITHUB_RELEASE="${{ github.event.inputs.push_to_github_release  ||  env.AUTO  }}"
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "SKIP_TESTS=$SKIP_TESTS" >> $GITHUB_ENV
          echo "JAVA_VERSION=$JAVA_VERSION" >> $GITHUB_ENV
          echo "JAR_DIR_PREFIX=$JAR_DIR_PREFIX" >> $GITHUB_ENV
          echo "DRAFT=$DRAFT" >> $GITHUB_ENV
          echo "PRERELEASE=$PRERELEASE" >> $GITHUB_ENV
          echo "PUSH_TO_REGISTRY=$PUSH_TO_REGISTRY" >> $GITHUB_ENV
          echo "PUSH_TO_GITHUB_RELEASE=$PUSH_TO_GITHUB_RELEASE" >> $GITHUB_ENV
          echo "设置的输入值: TAG_NAME=$TAG_NAME, SKIP_TESTS=$SKIP_TESTS, JAVA_VERSION=$JAVA_VERSION, JAR_DIR_PREFIX=$JAR_DIR_PREFIX, DRAFT=$DRAFT, PRERELEASE=$PRERELEASE,PUSH_TO_REGISTRY=$PUSH_TO_REGISTRY,PUSH_TO_GITHUB_RELEASE=$PUSH_TO_GITHUB_RELEASE"

      - name: 4.验证版本号
        run: |
          echo "当前版本号: $TAG_NAME"
          if ! [[ "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$ ]]; then
            echo "❌ 错误：版本格式必须符合语义化版本规范 (例如: v1.2.3, v1.2.3-alpha, v1.2.3+build.123)"
            exit 1
          fi
          echo "版本号验证通过"

      - name: 5.设置 Java 环境 version=${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: 6.缓存 Maven 依赖
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: 7.使用 Maven 构建并生成 JAR
        run: |
          if [ ${{ env.SKIP_TESTS }} ]; then
            echo "跳过测试"
            echo "mvn clean package -B -DskipTests -Dquickly"
            mvn clean package -B -DskipTests -Dquickly
          else
            echo "mvn clean package -B -Dquickly"
            mvn clean package -B -Dquickly
          fi
          echo "Maven 构建完成"
          echo "匹配的 JAR 文件 (*/target/*.jar):"
          find . -type f -path "*/target/*.jar"
          echo "匹配的 JAR 文件 (*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar):"
          find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar" || echo "未找到匹配的 JAR 文件"

      - name: 8.列出匹配的 JAR 文件
        run: |
          if [ "${{ env.JAR_DIR_PREFIX  }}" = "" ]; then
            echo "匹配的 JAR 文件 (*/target/*.jar):"
            find . -type f -path "*/target/*.jar" || echo "未找到匹配的 JAR 文件"
          else
            echo "匹配的 JAR 文件 (*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar):"
            find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar" || echo "未找到匹配的 JAR 文件"
          fi

      - name: 9.打包所有 JAR 文件成 ZIP
        run: |
          if [ "${{ env.JAR_DIR_PREFIX }}" = "" ]; then
            find . -type f -path "*/target/*.jar" -exec zip -j jars-${{ env.TAG_NAME }}.zip {} +
          else
            find . -type f -path "*/${{ env.JAR_DIR_PREFIX  }}/target/*.jar" -exec zip -j jars-${{ env.TAG_NAME }}.zip {} +
          fi
          # -j: 仅打包文件，不保留目录结构
          # +: 尽量将多个文件放入一个 zip 命令，减少调用次数
        shell: bash

      - name: 10.验证 ZIP 文件
        run: |
          ls -la jars-${{ env.TAG_NAME}}.zip
          echo "ZIP 文件内容:"
          unzip -l jars-${{ env.TAG_NAME }}.zip

      - name: 11.解压 ZIP 文件
        run: |
          mkdir -p extracted-jars
          unzip jars-${{ env.TAG_NAME }}.zip -d extracted-jars
          echo "解压后的文件:"
          ls -la extracted-jars

      - name: 11.5 将 JAR 文件转换为 EXE（简单可靠版本）
        run: |
          # 使用最稳定的方式下载 Launch4j 3.50 Linux x64 二进制版
          # SourceForge 的 /download 后缀有时不稳定，使用重定向安全的 mirrors 链接
          wget https://downloads.sourceforge.net/project/launch4j/launch4j-3/3.50/launch4j-3.50-linux.tgz?viasf=1 -O /tmp/launch4j.tgz
          # 解压到 /tmp
          tar -xzf /tmp/launch4j.tgz -C /tmp

          # 添加执行权限
          chmod +x /tmp/launch4j/launch4j

          # 遍历所有 JAR 文件
          for jar_file in extracted-jars/*.jar; do
            if [ -f "$jar_file" ]; then
              jar_name=$(basename "$jar_file" .jar)
              exe_output="extracted-jars/${jar_name}.exe"

              # 稳健提取 Main-Class（去除多余空格和回车）
              main_class=$(unzip -p "$jar_file" META-INF/MANIFEST.MF | grep '^Main-Class:' | sed 's/^Main-Class: *//' | tr -d '\r')

              if [ -z "$main_class" ]; then
                echo "⚠️ $jar_file 中未找到 Main-Class，跳过生成 EXE"
                continue
              fi

              # 生成正确的 Launch4j 配置 XML
              config_file="/tmp/${jar_name}_config.xml"
              cat > "$config_file" << EOF
          <launch4jConfig>
            <dontWrapJar>false</dontWrapJar>
            <headerType>gui</headerType>    <!-- 如为控制台程序，改为 console -->
            <jar>$jar_file</jar>
            <outfile>$exe_output</outfile>
            <classname>$main_class</classname>
            <jre>
              <minVersion>${{ env.JAVA_VERSION }}.0</minVersion>
              <jdkPreference>preferJre</jdkPreference>
            </jre>
            <versionInfo>
              <fileVersion>${TAG_NAME#v}.0.0.0</fileVersion>
              <txtFileVersion>${TAG_NAME}</txtFileVersion>
              <productVersion>${TAG_NAME#v}.0.0.0</productVersion>
              <txtProductVersion>${TAG_NAME}</txtProductVersion>
              <fileDescription>WsProxy Application</fileDescription>
              <copyright>Copyright (c) 2023</copyright>
              <productName>WsProxy</productName>
              <originalFilename>${jar_name}.exe</originalFilename>
            </versionInfo>
          </launch4jConfig>
          EOF

              # 执行 Launch4j 生成 EXE
              /tmp/launch4j/launch4j "$config_file"

              # 检查结果
              if [ -f "$exe_output" ]; then
                echo "✅ 成功生成: $exe_output"
              else
                echo "❌ 生成失败: $jar_file"
                echo "=== 配置内容（用于调试）==="
                cat "$config_file"
              fi
            fi
          done

          # 列出所有生成的 EXE
          echo "=== 生成的 EXE 文件 ==="
          ls -la extracted-jars/*.exe || echo "未生成任何 EXE 文件"
        shell: bash

      - name: 12.上传 ZIP 到 GitHub Release
        uses: softprops/action-gh-release@v2
        if: ${{ inputs.push_to_github_release == true  }}
        with:
          name: ${{ env.TAG_NAME }}
          files: |
            jars-${{ env.TAG_NAME }}.zip
            extracted-jars/*.jar
            extracted-jars/*.exe
          tag_name: ${{ env.TAG_NAME }}
          body: |
            **Release 信息**
            - 标签: ${{ env.TAG_NAME }}
            - Java 版本: ${{ env.JAVA_VERSION}}
          #            - 是否跳过测试: ${{ github.event.inputs.skip_tests == 'true' && '是' || '否' }}
          #            - Draft 状态: ${{ github.event.inputs.draft == 'true' && '是' || '否' }}
          #            - Pre-release 状态: ${{ github.event.inputs.prerelease == 'true' && '是' || '否' }}
          draft: ${{ env.DRAFT == true || false }}
          prerelease: ${{ env.PRERELEASE == true || false }}
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
      # 在步骤 12 之后添加新的 artifact 上传步骤
      - name: Upload JAR files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-files
          path: extracted-jars/*.jar
      - name: Upload EXE files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: exe-files
          path: extracted-jars/*.exe

  build-and-push:
    runs-on: ubuntu-latest
    needs: build-and-release  # 添加依赖关系
    permissions:
      contents: read
      packages: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 下载之前工作流的构建产物
      - name: Download JAR artifacts
        uses: actions/download-artifact@v4
        with:
          name: jar-files
          path: ./

      - name: List downloaded files
        run: ls -la ./

      # 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 登录到 GitHub Container Registry
      - name: Log in to Container Registry
        #        if: ${{ inputs.push_to_registry == true }}
        if: ${{ github.event_name == 'push' || inputs.push_to_registry == true }}
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 提取 Docker 镜像元数据
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ github.ref_name }}
            type=raw,value=latest


      # 构建并推送 Docker 镜像
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name == 'push' || inputs.push_to_registry == true }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            JAR_FILE_PATH=./*.jar

      # 验证构建的镜像
      - name: Verify Docker image
        run: |
          docker images
          if [ "${{ inputs.push_to_registry == true }}" ]; then
            echo "Docker image pushed successfully"
          else
            echo "Docker image built locally only"
          fi
       
